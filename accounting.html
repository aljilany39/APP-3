<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>برنامج محاسبي مبسّط (متصفح)</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#1f2937;--text:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--warn:#f59e0b;--shadow:0 10px 30px rgba(0,0,0,.3);} 
    *{box-sizing:border-box;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#111827);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:#0b1220aa;backdrop-filter:saturate(1.2) blur(8px);border-bottom:1px solid #243044}
    .wrap{max-width:1050px;margin:auto;padding:18px}
    h1{margin:8px 0 14px;font-size:22px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 14px;background:var(--muted);border:1px solid #2b364a;border-radius:12px;cursor:pointer;user-select:none}
    .tab.active{background:#0d2742;border-color:#2f6db7}
    .grid{display:grid;gap:14px}
    @media(min-width:900px){.grid-2{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #1f2a3d;border-radius:16px;box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px;font-size:18px}
    .card .body{padding:16px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,textarea{background:#0b1220;border:1px solid #26334a;color:var(--text);padding:10px;border-radius:10px;width:100%}
    textarea{min-height:70px}
    label{font-size:13px;opacity:.85}
    .btn{border:1px solid #2b364a;background:#0b1220;color:var(--text);padding:9px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:#0f3b1f;border-color:#1e7c4a}
    .btn.primary:hover{background:#125129}
    .btn.warn{background:#3b2e0f;border-color:#8c6a14}
    .btn.danger{background:#3b0f12;border-color:#84212a}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{border-bottom:1px solid #22304a;padding:10px;text-align:center;font-size:14px}
    thead th{background:#0f2139;position:sticky;top:0}
    .actions{display:flex;gap:6px;justify-content:center}
    .muted{opacity:.8;font-size:13px}
    .pill{display:inline-block;padding:3px 8px;border-radius:999px;border:1px solid #334155}
    .ok{color:#86efac;border-color:#166534}
    .bad{color:#fda4af;border-color:#7f1d1d}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal.show{display:flex}
    .modal .panel{background:var(--card);border:1px solid #26334a;border-radius:18px;max-width:1000px;width:100%;max-height:85vh;display:flex;flex-direction:column}
    .panel header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#0f2139;border-bottom:1px solid #243044}
    .panel header h3{margin:0;font-size:18px}
    .panel .content{padding:14px;overflow:auto}
    .totals{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .total{padding:8px 12px;background:#0b1220;border:1px solid #2b364a;border-radius:10px}
    .hint{font-size:12px;opacity:.8;margin-top:6px}
    .empty{padding:16px;text-align:center;opacity:.8}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>برنامج محاسبي مبسّط (سندات + كشوف منبثقة)</h1>
      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="ops">العمليات (سندات)</button>
        <button class="tab" data-tab="parties">العملاء والموردين</button>
        <button class="tab" data-tab="funds">الصناديق</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- العمليات -->
    <section id="tab-ops">
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h2>سند قبض (من عميل → إلى صندوق)</h2>
            <div class="row">
              <div style="flex:2">
                <label>العميل</label>
                <select id="rcptCustomer"></select>
              </div>
              <div style="flex:2">
                <label>الصندوق</label>
                <select id="rcptFund"></select>
              </div>
              <div style="flex:1">
                <label>المبلغ</label>
                <input id="rcptAmount" type="number" min="0" step="0.01" placeholder="0.00" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1">
                <label>التاريخ</label>
                <input id="rcptDate" type="date" />
              </div>
              <div style="flex:2">
                <label>ملاحظة</label>
                <input id="rcptNote" type="text" placeholder="اختياري" />
              </div>
            </div>
            <div class="row" style="margin-top:10px;justify-content:flex-end">
              <button class="btn primary" id="btnAddReceipt">حفظ سند القبض</button>
            </div>
            <div class="hint">يسجّل رصيدًا <span class="pill ok">(+)</span> للصندوق ويقلّل رصيد العميل (يظهر كقيمة سالبة في كشفه).</div>
          </div>
        </div>

        <div class="card">
          <div class="body">
            <h2>سند صرف (من صندوق → إلى مورد/مصروف)</h2>
            <div class="row">
              <div style="flex:2">
                <label>المورد</label>
                <select id="paySupplier"></select>
              </div>
              <div style="flex:2">
                <label>الصندوق</label>
                <select id="payFund"></select>
              </div>
              <div style="flex:1">
                <label>المبلغ</label>
                <input id="payAmount" type="number" min="0" step="0.01" placeholder="0.00" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1">
                <label>التاريخ</label>
                <input id="payDate" type="date" />
              </div>
              <div style="flex:2">
                <label>ملاحظة</label>
                <input id="payNote" type="text" placeholder="اختياري" />
              </div>
            </div>
            <div class="row" style="margin-top:10px;justify-content:flex-end">
              <button class="btn primary" id="btnAddPayment">حفظ سند الصرف</button>
            </div>
            <div class="hint">يسجّل رصيدًا <span class="pill bad">(-)</span> للصندوق ويقلّل رصيد المورد (يظهر كقيمة سالبة في كشفه).</div>
          </div>
        </div>
      </div>
    </section>

    <!-- العملاء والموردين -->
    <section id="tab-parties" style="display:none">
      <div class="grid grid-2">
        <div class="card">
          <div class="body">
            <h2>العملاء</h2>
            <div class="row">
              <input id="custName" placeholder="اسم العميل" />
              <button class="btn primary" id="addCustomer">إضافة</button>
            </div>
            <div class="hint">لا يمكن حذف عميل عليه حركات.</div>
            <div id="customersTableWrap" style="margin-top:10px"></div>
          </div>
        </div>
        <div class="card">
          <div class="body">
            <h2>الموردون</h2>
            <div class="row">
              <input id="suppName" placeholder="اسم المورد" />
              <button class="btn primary" id="addSupplier">إضافة</button>
            </div>
            <div class="hint">لا يمكن حذف مورد عليه حركات.</div>
            <div id="suppliersTableWrap" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- الصناديق -->
    <section id="tab-funds" style="display:none">
      <div class="card">
        <div class="body">
          <h2>الصناديق</h2>
          <div class="row">
            <input id="fundName" placeholder="اسم الصندوق" />
            <input id="fundOpenBal" type="number" step="0.01" placeholder="رصيد افتتاحي (اختياري)" />
            <button class="btn primary" id="addFund">إضافة</button>
          </div>
          <div class="hint">الرصيد الحالي = الافتتاحي ± الحركات. لا يمكن حذف صندوق عليه حركات.</div>
          <div id="fundsTableWrap" style="margin-top:10px"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal كشف الحساب -->
  <div class="modal" id="statementModal" aria-hidden="true">
    <div class="panel">
      <header>
        <h3 id="statementTitle">كشف الحساب</h3>
        <div class="actions"><button class="btn" id="closeModal">إغلاق</button></div>
      </header>
      <div class="content">
        <div id="statementInfo" class="muted" style="margin-bottom:8px"></div>
        <div style="overflow:auto">
          <table id="statementTable">
            <thead>
              <tr>
                <th>التاريخ</th>
                <th>النوع</th>
                <th>الوصف</th>
                <th>مدين</th>
                <th>دائن</th>
                <th>الرصيد بعد الحركة</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="totals" style="margin-top:10px">
          <div class="total">الرصيد النهائي: <b id="finalBalance">0.00</b></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- تخزين ---
    const KEY='mini-acc-data-v1';
    const nowDate=()=>new Date().toISOString().slice(0,10);
    const uid=()=>Date.now().toString(36)+Math.random().toString(36).slice(2,8);
    const money=n=>Number(n||0).toFixed(2);

    const load=()=>{
      const raw=localStorage.getItem(KEY);
      if(!raw) return {customers:[],suppliers:[],funds:[],tx:[]};
      try{return JSON.parse(raw);}catch{ return {customers:[],suppliers:[],funds:[],tx:[]}; }
    }
    const save=()=>localStorage.setItem(KEY, JSON.stringify(DB));

    let DB=load();

    // --- تبويب ---
    document.querySelectorAll('#tabs .tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('#tabs .tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const id=btn.dataset.tab;
        ['ops','parties','funds'].forEach(t=>{
          document.getElementById('tab-'+t).style.display=(t===id)?'block':'none';
        });
      });
    });

    // --- عناصر ---
    const el={
      rcptCustomer:document.getElementById('rcptCustomer'),
      rcptFund:document.getElementById('rcptFund'),
      rcptAmount:document.getElementById('rcptAmount'),
      rcptDate:document.getElementById('rcptDate'),
      rcptNote:document.getElementById('rcptNote'),
      paySupplier:document.getElementById('paySupplier'),
      payFund:document.getElementById('payFund'),
      payAmount:document.getElementById('payAmount'),
      payDate:document.getElementById('payDate'),
      payNote:document.getElementById('payNote'),
      customersTableWrap:document.getElementById('customersTableWrap'),
      suppliersTableWrap:document.getElementById('suppliersTableWrap'),
      fundsTableWrap:document.getElementById('fundsTableWrap'),
      custName:document.getElementById('custName'),
      suppName:document.getElementById('suppName'),
      fundName:document.getElementById('fundName'),
      fundOpenBal:document.getElementById('fundOpenBal'),
      modal:document.getElementById('statementModal'),
      stTitle:document.getElementById('statementTitle'),
      stInfo:document.getElementById('statementInfo'),
      stTable:document.querySelector('#statementTable tbody'),
      stFinal:document.getElementById('finalBalance'),
    };

    // قيم افتراضية
    el.rcptDate.value = el.payDate.value = nowDate();

    // --- رندرة لائحات الاختيار ---
    function refreshSelectors(){
      const fill=(sel,arr,placeholder)=>{
        sel.innerHTML='';
        const opt0=document.createElement('option');
        opt0.value=''; opt0.textContent=placeholder; sel.appendChild(opt0);
        arr.forEach(x=>{
          const o=document.createElement('option'); o.value=x.id; o.textContent=x.name; sel.appendChild(o);
        });
      };
      fill(el.rcptCustomer, DB.customers, 'اختر عميل');
      fill(el.rcptFund, DB.funds, 'اختر صندوق');
      fill(el.paySupplier, DB.suppliers, 'اختر مورد');
      fill(el.payFund, DB.funds, 'اختر صندوق');
    }

    // --- جداول: زبائن/موردين/صناديق ---
    function hasMovementsFor(kind, id){
      // kind: 'customer' | 'supplier' | 'fund'
      return DB.tx.some(t=> (kind==='customer' && t.customerId===id) ||
                             (kind==='supplier' && t.supplierId===id) ||
                             (kind==='fund' && t.fundId===id));
    }

    function tableHtml(items, kind){
      if(!items.length) return `<div class="empty">لا توجد بيانات بعد.</div>`;
      let headers='';
      if(kind==='fund') headers='<th>الاسم</th><th>الرصيد الحالي</th><th>إجراءات</th>';
      else headers='<th>الاسم</th><th>إجراءات</th>';

      let rows='';
      items.forEach(x=>{
        const statementBtn = `<button class="btn" data-act="statement" data-kind="${kind}" data-id="${x.id}">عرض كشف الحساب</button>`;
        const editBtn = `<button class="btn warn" data-act="edit" data-kind="${kind}" data-id="${x.id}">تعديل</button>`;
        const delBtn = `<button class="btn danger" data-act="del" data-kind="${kind}" data-id="${x.id}">حذف</button>`;
        if(kind==='fund'){
          const bal = calcFundBalance(x.id);
          rows += `<tr><td>${x.name}</td><td><span class="pill ${bal>=0?'ok':'bad'}">${money(bal)}</span></td><td class="actions">${statementBtn}${editBtn}${delBtn}</td></tr>`;
        }else{
          rows += `<tr><td>${x.name}</td><td class="actions">${statementBtn}${editBtn}${delBtn}</td></tr>`;
        }
      });
      return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
    }

    function renderLists(){
      el.customersTableWrap.innerHTML = tableHtml(DB.customers, 'customer');
      el.suppliersTableWrap.innerHTML = tableHtml(DB.suppliers, 'supplier');
      el.fundsTableWrap.innerHTML     = tableHtml(DB.funds, 'fund');

      // attach actions
      [el.customersTableWrap, el.suppliersTableWrap, el.fundsTableWrap].forEach(wrap=>{
        wrap.querySelectorAll('button[data-act]')?.forEach(btn=>{
          btn.addEventListener('click', onTableAction);
        });
      });
      refreshSelectors();
    }

    function onTableAction(e){
      const btn=e.currentTarget;
      const act=btn.dataset.act; const kind=btn.dataset.kind; const id=btn.dataset.id;
      const list = kind==='customer'? DB.customers : kind==='supplier'? DB.suppliers : DB.funds;
      const idx = list.findIndex(x=>x.id===id);
      if(idx<0) return;
      if(act==='del'){
        if(hasMovementsFor(kind,id)) return alert('لا يمكن حذف حساب عليه حركات.');
        if(confirm('تأكيد حذف؟')){ list.splice(idx,1); save(); renderLists(); }
      }else if(act==='edit'){
        const name=prompt('اسم جديد', list[idx].name);
        if(name && name.trim()){ list[idx].name=name.trim(); save(); renderLists(); }
      }else if(act==='statement'){
        openStatement(kind, list[idx]);
      }
    }

    // --- أرصدة ---
    function calcFundBalance(fundId){
      const fund = DB.funds.find(f=>f.id===fundId);
      const open = Number(fund?.open||0);
      let bal=open;
      DB.tx.forEach(t=>{
        if(t.fundId!==fundId) return;
        if(t.type==='receipt') bal += Number(t.amount);
        if(t.type==='payment') bal -= Number(t.amount);
      });
      return bal;
    }

    // --- إضافة كيانات ---
    document.getElementById('addCustomer').onclick=()=>{
      const name=el.custName.value.trim(); if(!name) return alert('أدخل الاسم');
      DB.customers.push({id:uid(), name}); el.custName.value=''; save(); renderLists();
    };
    document.getElementById('addSupplier').onclick=()=>{
      const name=el.suppName.value.trim(); if(!name) return alert('أدخل الاسم');
      DB.suppliers.push({id:uid(), name}); el.suppName.value=''; save(); renderLists();
    };
    document.getElementById('addFund').onclick=()=>{
      const name=el.fundName.value.trim(); if(!name) return alert('أدخل الاسم');
      const open=Number(el.fundOpenBal.value||0);
      DB.funds.push({id:uid(), name, open}); el.fundName.value=''; el.fundOpenBal.value=''; save(); renderLists();
    };

    // --- إضافة سندات ---
    document.getElementById('btnAddReceipt').onclick=()=>{
      const customerId=el.rcptCustomer.value; const fundId=el.rcptFund.value; const amount=Number(el.rcptAmount.value||0);
      const date=el.rcptDate.value || nowDate(); const note=el.rcptNote.value.trim();
      if(!customerId||!fundId||!(amount>0)) return alert('أكمل الحقول المطلوبة');
      DB.tx.push({id:uid(), type:'receipt', customerId, fundId, amount, date, note});
      el.rcptAmount.value=''; el.rcptNote.value=''; save(); renderLists();
      alert('تم حفظ سند القبض');
    };
    document.getElementById('btnAddPayment').onclick=()=>{
      const supplierId=el.paySupplier.value; const fundId=el.payFund.value; const amount=Number(el.payAmount.value||0);
      const date=el.payDate.value || nowDate(); const note=el.payNote.value.trim();
      if(!supplierId||!fundId||!(amount>0)) return alert('أكمل الحقول المطلوبة');
      DB.tx.push({id:uid(), type:'payment', supplierId, fundId, amount, date, note});
      el.payAmount.value=''; el.payNote.value=''; save(); renderLists();
      alert('تم حفظ سند الصرف');
    };

    // --- كشف الحساب المنبثق ---
    function openStatement(kind, entity){
      // kind: customer | supplier | fund
      el.stTitle.textContent = `كشف حساب – ${entity.name}`;
      el.stInfo.textContent  = kind==='fund' ? 'يشمل سندات القبض (+) والصرف (-) على هذا الصندوق.'
                          : (kind==='customer' ? 'يشمل سندات القبض فقط لهذا العميل (تظهر كقيد دائن يُنقص الرصيد).'
                                               : 'يشمل سندات الصرف فقط لهذا المورد (تظهر كقيد دائن يُنقص الرصيد).');
      el.stTable.innerHTML='';

      // جمع الحركات الخاصة
      let rows=[];
      if(kind==='customer') rows = DB.tx.filter(t=>t.type==='receipt' && t.customerId===entity.id);
      if(kind==='supplier') rows = DB.tx.filter(t=>t.type==='payment' && t.supplierId===entity.id);
      if(kind==='fund')     rows = DB.tx.filter(t=>t.fundId===entity.id);

      // ترتيب بالتاريخ ثم بالإدخال
      rows.sort((a,b)=> (a.date||'')< (b.date||'') ? -1 : (a.date||'')>(b.date||'') ? 1 : 0);

      let running= kind==='fund' ? Number(entity.open||0) : 0;
      if(kind==='fund' && rows.length===0){ running = Number(entity.open||0); }

      if(rows.length===0){
        el.stTable.innerHTML = `<tr><td colspan="6" class="empty">لا توجد حركات.</td></tr>`;
        el.stFinal.textContent = money(running);
        el.modal.classList.add('show');
        return;
      }

      rows.forEach(t=>{
        const typeTxt = t.type==='receipt' ? 'سند قبض' : 'سند صرف';
        let debit=''; let credit='';
        if(kind==='fund'){
          if(t.type==='receipt'){ running += Number(t.amount); debit=money(t.amount); }
          else { running -= Number(t.amount); credit=money(t.amount); }
        } else if(kind==='customer'){
          // القبض من العميل ينقص رصيده
          credit=money(t.amount); running -= Number(t.amount);
        } else if(kind==='supplier'){
          // الصرف للمورد ينقص رصيده
          credit=money(t.amount); running -= Number(t.amount);
        }
        const desc = (t.note||'') + (kind!=='fund' ? ` [صندوق: ${(DB.funds.find(f=>f.id===t.fundId)?.name)||'-'}]` :
                                      ` ${(t.customerId?`[عميل: ${(DB.customers.find(c=>c.id===t.customerId)?.name)||'-'}]`: t.supplierId?`[مورد: ${(DB.suppliers.find(s=>s.id===t.supplierId)?.name)||'-'}]`:'')}`);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${t.date||''}</td><td>${typeTxt}</td><td>${desc}</td><td>${debit||''}</td><td>${credit||''}</td><td>${money(running)}</td>`;
        el.stTable.appendChild(tr);
      });

      el.stFinal.textContent = money(running);
      el.modal.classList.add('show');
    }

    document.getElementById('closeModal').onclick=()=> el.modal.classList.remove('show');
    el.modal.addEventListener('click',e=>{ if(e.target===el.modal) el.modal.classList.remove('show'); });

    // --- بداية ---
    renderLists();
  </script>
</body>
</html>
